var express = require('express');
var app = express();
var fs = require("fs");
var bodyParser = require('body-parser');
var yamlconfig = require('yaml-config');
var configYaml = yamlconfig.readConfig('../config/config.yml');
var Apiclient = require('apiclient');
var md5 = require('md5');
var path = require("path");

var host = configYaml.user_management.host;
var port = configYaml.user_management.port;

//orm
var Database = require("../mysql/Mysql.js");
var Api_privilege = Database('Privilege');
var Api_inventory = Database('Inventory');
var Api_cluster = Database('Cluster');
var Api_project = Database('Project');
var Api_member = Database('Member');
var Api_group = Database('Group');
var Api_role = Database('Role');
var Api_user = Database('User');

//setting midleware
app.use (function(req,res,next){
  res.header("Access-Control-Allow-Origin", "*");
  res.header("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept");
  res.header("Access-Control-Allow-Methods", "DELETE, GET, POST, PUT, OPTIONS");
//  res.removeHeader("x-powered-by");
  next();
});

// parse application/x-www-form-urlencoded
app.use(bodyParser.urlencoded({ extended: false }))

// parse application/json
app.use(bodyParser.json())
var id = /^[0-9]*$/;
var ip = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
var valid = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;

var User = {
			get: function getUser(req, res){
				var ipAddres = req.connection.remoteAddress;
        var apikey = req.params.apikey;
        checkApikey(apikey, ipAddres, function(result){
	if(result.err_code==0){
              var user_id = req.params.user_id;
              if(typeof user_id !== 'undefined'){
                if(id.test(user_id)){
                  //check akses get user, hanya boleh admin dan dirinya sendiri
                  if(user_id==result.data[0].user_id||result.status=="root"){
                    //query mencari user berdasarkan id
                    Api_user.findById({"user_id": user_id}, function(err,data){
                      if(err){
                        res.json(err);
                      }else{
                        //show data
                        if(data.length>0){
                          //menampilkan data user
                          showUser(data,function(dataUser){
                            res.json({"err_code" : 0, "data" : dataUser});
                          });
                        }else{
                          res.json({"err_code" : 2, "err_msg": "User ID is not found"});
                        }
                      }
                  });
                  }else{
                    res.json({"err_code": 5, "err_msg": "Access denied to view user"});
                  }
                }else{
                  res.json({"err_code" : 2, "err_msg": "User ID must be numeric"});
                }
              }else{
                //check akses get all user, hanya boleh admin
                if(result.status=="root"){
                  //query untuk menampilkan semua list user
                  Api_user.find({}, function(err,data){
                    if(err){
                      if(data.errcode==1)
                        res.json(data);
                      else
                        res.json(err);
                    }else{
                      	//cek jumdata dulu
    								  	if(data.length > 0){
                          //menampilkan data user
                          showUser(data,function(dataUser){
                              res.json({"err_code": 0, "data":dataUser});
    								  	  });
                        }else{
    							  			res.json({"err_code": 4, "err_msg": "User data is empty", "application": "Api User Management", "function": "getUser"});
    								  	}
                    }
                  });
                }else{
                  res.json({"err_code": 5, "err_msg": "Access denied to view users"});
                }
              }
          }else{
						result.err_code = 500;
						res.json(result);
					}
				});
			},
			post: function addUser(req, res){
				var ipAddres = req.connection.remoteAddress;
        var apikey = req.params.apikey;
				var user_email = req.body.user_email;
        var user_role_id = req.body.user_role_id;
        checkApikey(apikey, ipAddres, function(result){
          //check akses tambah user, hanya boleh admin
          if(result.status == "root"){
						if(typeof req.body.user_firstname !== 'undefined'&& req.body.user_firstname!==""){
              //cek email data user apakah sudah ada atau belum dan valid atau tidak
              checkEmail(apikey, user_email, function(result2){
  							if(result2.err_code == 0){
                   if(typeof req.body.user_password !== 'undefined' && req.body.user_password!==""){
                      if(typeof req.body.user_ip_address !== 'undefined' && ip.test(req.body.user_ip_address)){
                        //ambil id user terakhir
                        getUserId(apikey, function(result3){
        									if(result3.err_code == 0){
        										//susun body
        										if(typeof req.body.user_lastname == 'undefined')
                                req.body.user_lastname = "";
                              var dataUser = {
          																			"user_id": result3.user_id,
          																			"user_firstname": req.body.user_firstname.replace(/ /g,""),
          																			"user_lastname": req.body.user_lastname.replace(/ /g,""),
          																			"user_email": req.body.user_email,
          																			"user_apikey": generateApikey(getFormattedDate()),
          																			"user_create_date": getFormattedDate(),
          																			"user_password": md5(req.body.user_password),
          																			"user_is_active": true,
          																			"user_ip_address": req.body.user_ip_address,
                                                "user_role_id": req.body.user_role_id
          																		};
          										//proses tambah data user ke database
                              console.log(dataUser);
                              Api_user.add(dataUser,function(err,data){
                                //cek apakah ada error atau tidak
                                if(err){
          										  	res.json({"err_code": 1, "err_msg": err, "application": "Api User Management", "function": "addUser"});
          										  }else{
          										  	if(data.errcode == 0){
                                    //ambil data user yang sudah di tambahkan
                                    Api_user.findById({"user_id": result3.user_id}, function(err,datapost){
                                      showUser(datapost,function(dataUser){
                                        res.json({"err_code": 0, "data" : dataUser});
              								  	    });
                                    });
          										  	}else{
          										  		res.json(data);
          										  	}
          										  }
          										});
                            }else{
        										result.err_code = 500;
        										res.json(result3);
        									}
        								});
                      }else{
                        res.json({"err_code" : 2, "status" : "IP address is invalid"});
                      }
                    }else{
                      res.json({"err_code" : 2, "status" : "Password is invalid"});
                    }
  							}else{
  								result.err_code = 500;
  								res.json(result2);
  							}
  						})
             }else{
                res.json({"err_code" : 2, "status" : "First name is required"});
             }
					}else{
						res.json({"err_code": 3, "err_msg": "Access denied"});
					}
				});
			},
			put: function updateUser(req, res){
				if(Object.keys(req.body).length){
        var ipAddres = req.connection.remoteAddress;
				var apikey = req.params.apikey;
        checkApikey(apikey, ipAddres, function(result){
					if(result.err_code == 0){
						//proses query ambil data user
						var user_id = req.params.user_id;
						if(typeof user_id !== 'undefined'&&id.test(user_id)){
							checkUser(user_id,function(result2){
                //check akses update, hanya boleh admin dan dirinya sendiri
                if(result2.err_code==0&&(result.data[0].user_id==result2.data[0].user_id||result.status=="root")){
                  //cek untuk data yang akan diupdate
                  var dataUser= {};
                  var params = true;
                  if(typeof req.body.user_firstname !== 'undefined'&&req.body.user_firstname!==""){
    								dataUser.user_firstname = req.body.user_firstname.replace(/ /g,"");
    							}else if(req.body.user_firstname =="")
                    params=false;

    							if(typeof req.body.user_lastname !== 'undefined'&&req.body.user_lastname!==""){
    								dataUser.user_lastname = req.body.user_lastname.replace(/ /g,"");
    							}else if(req.body.user_lastname =="")
                    params=false;

                  var status_email=true;
    							if(typeof req.body.user_email !== 'undefined'&&req.body.user_email!==""){
                    if(valid.test(req.body.user_email))
                      dataUser.user_email = req.body.user_email;
                    else
                      status_email=false;
    							}else if(req.body.user_email =="")
                    params=false;

    							if(typeof req.body.user_password !== 'undefined'&&req.body.user_password!==""){
    								dataUser.user_password = md5(req.body.user_password);
    							}else if(req.body.user_password =="")
                    params=false;

    							if(typeof req.body.user_is_active !== 'undefined'&&req.body.user_is_active!==""){
    								dataUser.user_is_active = req.body.user_is_active;
    							}else if(req.body.user_is_active =="")
                    params=false;

                  var status_ip=true;
                  if(typeof req.body.user_ip_address !== 'undefined'&&req.body.user_ip_address!==""){
                    var ip_body = req.body.user_ip_address.split(",");
                    var ip_insert = "";
                    for(key in ip_body){
                      if(ip.test(ip_body[key])){
                        if(result2.data[0].user_ip_address.indexOf(ip_body[key])>=0)
                          continue;
                        else
                            ip_insert+=","+ip_body[key];
                      }else{
                        status_ip=false;
                      }
                    }
                    if(ip_insert!=="")
                      dataUser.user_ip_address = ""+result2.data[0].user_ip_address+ip_insert;
    							}else if(req.body.user_ip_address =="")
                    params=false;

                  if(typeof req.body.user_role_id !== 'undefined'&&req.body.user_role_id !==""){
    								dataUser.user_role_id = req.body.user_role_id;
   							  }else if(req.body.user_role_id =="")
                    params=false;

                  if(typeof req.body.user_cluster_id !== 'undefined'&&req.body.user_cluster_id !==""){
    								dataUser.user_cluster_id = req.body.user_cluster_id;
   							  }else if(req.body.user_cluster_id =="")
                    params=false;

                  dataUser.user_update_date = getFormattedDate();
    							if(params){
                    if(status_email){
                     if(status_ip){
                       checkRoleId(dataUser,function(result3){
                        if(result3.err_code==0){
                          checkClusterId(dataUser,function(result4){
                           if(result4.err_code==0){
                             Api_user.update({"user_id" : user_id},dataUser,function(err,data){
                                 if(err){
                                   if(data.errcode==1)
                                      res.json(data);
                                    else
                                      res.json(err);
                                 }else{
                                   Api_user.findById({"user_id": user_id}, function(err,dataUpdate){
                                      showUser(dataUpdate,function(dataUser){
                                        res.json({"err_code": 0, "data" : dataUser});
              								  	    });
                                   });
                                 }
                             });
                           }else{
                             res.json(result4)
                           }
                         });
                        }else{
                          res.json(result3)
                        }
                      });
                     }else{
                       res.json({"err_code" : 2, "status" : "IP address is invalid"});
                     }
                   }else{
                     res.json({"err_code" : 2, "status" : "Email is invalid"});
                   }
                 }else{
                   res.json({"err_code" : 3, "status" : "Parameters cannot Empty"});
                 }
               }else if(result2.err_code==1){
                 res.json({"err_code": 2, "err_msg": "User ID is not found"});
               }else{
                  res.json({"err_code": 3, "err_msg": "Access denied"});
                }
              });
            }else{
							res.json({"err_code": 2, "err_msg": "User iD must be numeric"});
						}
					}else{
						result.err_code = 500;
						res.json(result);
					}
				});
        }else{
          res.json({"err_code": 500, "err_msg": "Body cannot Empty"});
        }
			},
			delete: function deleteUser(req, res){
				var ipAddres = req.connection.remoteAddress;
				var apikey = req.params.apikey;

				checkApikey(apikey, ipAddres, function(result){
					if(result.err_code == 0){
						//proses query ambil data user
						var user_id = req.params.user_id;
						if(typeof user_id !== 'undefined'&&id.test(user_id)){
              checkUser(user_id,function(result2){
                //check akses delete, hanya boleh admin
                if(result2.err_code==0&&result.status=="root"){
                  //hapus user
                  Api_user.delete([{"user_id" : user_id}], function(err1,dataUser){
                    if(err1){
                      if(dataUser.errcode==1)
                        res.json({"err_code": 2, "err_msg": "User ID is not found"});
                      else
                        res.json(err1);
                    }else{
                      //delete project and inventory yang tidak di share oleh user
                      Api_project.findWhereAnd([{"project_user_id" : user_id},{"project_is_share" : false}],function(err,data){
                        if(data.length>0){
                          Api_project.delete([{"project_user_id" : user_id},{"project_is_share" : false}],function(err,data){                            
                          });
                          for(key in data){
                            Api_inventory.delete([{"project_inventory_id" : data[key].project_id}],function(err,data){                              
                            });
                          }
                        }
                      });
                      //cek termasuk dalam member atau tidak
                      checkUserAsMember([{"user_id" : user_id}],function(result2){
                        if(result2.err_code==0){
                          //termasuk dalam member
                          var count=0;
                          for(key in result2.data){
                            //console.log(count);
                            //console.log(result2.data.length);
                            //check tiap keanggotaan dari user id yang di hapus dalam group
                            Api_group.findJoin({"group_id" : result2.data[key].group_id},{Member : "group_id"},function(err,dataGroup){
                              //hapus member
                              Api_member.delete([{"group_id" : dataGroup[0].group_id},{"user_id" : user_id}], function(err,data){});
                              var dataMember = dataGroup[0].Members;
                              //check kuota group
                              if(dataMember.length>1){
                                //check member as admin's group
                                if(dataGroup[0].group_user_id==user_id){
                                  console.log("user is admin's group");
                                  //change admin's group to member with member_id below him/his
                                  console.log("update admin's group");
                                  var updateAdmin = {"group_user_id" : dataMember[1].user_id, "group_update_date" : getFormattedDate()};
                                  Api_group.update({"group_id" : dataGroup[0].group_id},updateAdmin,function(err,data){});
                                  var updateMember = {"member_role" : "Administrator", "member_update_date" :getFormattedDate()};
                                  Api_member.update({"member_id" : dataMember[1].member_id},updateMember,function(err,data){});

                                  //check project for user
                                  Api_project.findWhereAnd([{"project_user_id" : user_id},{"project_group_id" : dataGroup[0].group_id}],function(err,dataProject){
                                    if(dataProject.length>0){
                                      console.log("check user's project");
                                      for(key in dataProject){
                                        //check project_is_share
                                        //if project_is_share, change the owner to new admin's group(ga jadi). if not, delete project and inventory
                                        if(dataProject[key].project_is_share){
                                          //project di biarkan
                                          console.log("check user's project is share");
                                          // var updateProject = {"project_user_id" : dataMember[1].user_id};
                                          // Api_project.update({"project_id" : dataProject[key].project_id},updateProject,function(err,data){});
                                          if(count==result2.data.length-1)
                                            res.json({"err_code": 0, "status": "User has been deleted"})
                                          if(key==dataProject.length-1)
                                            count++;
                                        }else{
                                          // console.log("check user's project is not share, delete project and inventory");
                                          // Api_project.delete([{"project_id" : dataProject[key].project_id}],function(err,data){});
                                          // Api_inventory.delete([{"project_inventory_id" : dataProject[key].project_id}],function(err,data){});
                                          if(count==result2.data.length-1)
                                            res.json({"err_code": 0, "status": "User has been deleted"})
                                          if(key==dataProject.length-1)
                                            count++;
                                        }
                                      }
                                    }else{
                                      if(count==result2.data.length-1)
                                        res.json({"err_code": 0, "status": "User has been deleted"})
                                      else
                                        count++;
                                    }
                                  });
                                }else{
                                  console.log("user is only just a member group");
                                  Api_project.findWhereAnd([{"project_user_id" : user_id},{"project_group_id" : dataGroup[0].group_id}],function(err,dataProject){
                                    if(dataProject.length>0){
                                      console.log("check user's project");
                                      console.log(dataProject.length);
                                      for(key in dataProject){
                                        //check project_is_share
                                        //if project_is_share, change the owner to new admin's group(ga jadi). if not, delete project and inventory
                                        if(dataProject[key].project_is_share){
                                          //project dibiarkan
                                          console.log("user's project is share");
                                          // var updateProject = {"project_user_id" : dataMember[0].user_id};
                                          // Api_project.update({"project_id" : dataProject[key].project_id},updateProject,function(err,data){});
                                          if(count==result2.data.length-1)
                                            res.json({"err_code": 0, "status": "User has been deleted"});
                                          if(key==dataProject.length-1)
                                            count++;
                                        }else{
                                          // console.log("user's project is not share, delete project and inventory");
                                          // Api_project.delete([{"project_id" : dataProject[key].project_id}],function(err,data){});
                                          // Api_inventory.delete([{"project_inventory_id" : dataProject[key].project_id}],function(err,data){});
                                          if(count==result2.data.length-1)
                                            res.json({"err_code": 0, "status": "User has been deleted"});
                                          if(key==dataProject.length-1)
                                            count++;
                                        }
                                      }
                                    }else{
                                      if(count==result2.data.length-1)
                                        res.json({"err_code": 0, "status": "User has been deleted"});
                                      else
                                        count++;
                                    }
                                  });
                                }
                              }else{
                                //if member there is only just admin's group in group, delete group and all project yang dimiliki admin
                                console.log("delete group, because there is only admin in group");
                                Api_group.delete([{"group_id" : dataGroup[0].group_id}],function(err,data){});
                                Api_project.findWhereAnd([{"project_user_id" : user_id},{"project_group_id" : dataGroup[0].group_id}],function(err,dataProject){
                                  if(dataProject.length>0){
                                    Api_project.delete([{"project_user_id" : user_id},{"project_group_id" : dataGroup[0].group_id}],function(err,data){
                                      //ubah status project dalam group yang bukan milik user
                                      var updateProject = {
                                        "project_group_id" : null,
                                        "project_is_share" : false,
                                        "project_update_date" : getFormattedDate()
                                      };
                                      Api_project.update({"project_group_id" : dataGroup[0].group_id},updateProject,function(err,data){});
                                    });
                                    for(key in dataProject){
                                      if(count==result2.data.length-1)
                                        res.json({"err_code": 0, "status": "User has been deleted"});
                                      if(key==dataProject.length-1){
                                        count++;
                                      }else{
                                        Api_inventory.delete([{"project_inventory_id" : dataProject[key].project_id}],function(err,data){});
                                      }
                                    }
                                  }else{
                                    if(count==result2.data.length-1)
                                      res.json({"err_code": 0, "status": "User has been deleted"});
                                    else
                                      count++;
                                  }
                                });
                              }
                            });
                          }
                        }else{
                          //tidak termasuk dalam member
                          // Api_project.findWhere({"project_user_id" : user_id},function(err,dataProject){
                          //   if(dataProject.length>0){
                          //     //hapus semua project dan inventory yang dimiliki user
                          //     Api_project.delete([{"project_user_id" : user_id}],function(err,data){});
                          //     for(key in dataProject){
                          //       if(key==dataProject.length-1){
                          //         res.json({"err_code": 0, "status": "User has been deleted"})
                          //       }else{
                          //         Api_inventory.delete([{"project_inventory_id" : dataProject[key].project_id}],function(err,data){});
                          //       }
                          //     }
                          //   }else{
                               res.json({"err_code": 0, "status": "User has been deleted"})
                          //   }
                          // });
                        }
                      });
                    }
                  });
                }else if(result2.err_code==1){
                  res.json({"err_code": 2, "err_msg": "User ID is not found"});
                }else{
                  res.json({"err_code": 3, "err_msg": "Access denied. Cannot delete this user"});
                }
              });
            }else{
							res.json({"err_code": 1, "err_msg": "User ID must be numeric"});
						}
					}else{
						result.err_code = 500;
						res.json(result);
					}
				});
			}
}

var Group = {
			get:{
        group : function getGroup(req, res){
  				var ipAddres = req.connection.remoteAddress;
  				var apikey = req.params.apikey;

  				checkApikey(apikey, ipAddres, function(result){
					if(result.err_code == 0){
						//proses query ambil data group
						var group_id = req.params.group_id;
						if(typeof group_id !== 'undefined'){
              if(id.test(group_id)){
  							Api_group.findById({"group_id": group_id}, function(err,data){
                    if(err){
                       res.json(err);
                    }else{
                      //show data
                      if(data.length>0){
                        //convert date
                        showGroup(data,function(dataGroup){
                          res.json({"err_code" : 0, "data" : dataGroup});
                        });
                      }else{
                        res.json({"err_code" : 2, "err_msg": "Group ID is not found"});
                      }
                    }
                });
              }else{
                res.json({"err_code" : 2, "err_msg": "Group iD must be numeric"});
              }
            }else{
							Api_group.find({}, function(err,data){
                if(err){
                  if(data.errcode==1)
                    res.json(data);
                  else
                    res.json(err);
                }else{
               	  //cek jumdata dulu
  							  if(data.length > 0){
                    showGroup(data,function(dataGroup){
                      res.json({"err_code" : 0, "data" : dataGroup});
                    });
  							  }else{
  						  		res.json({"err_code": 4, "err_msg": "Group data is empty", "application": "Api User Management", "function": "getGroup"});
  							  }
                }
              });
            }
					}else{
						result.err_code = 500;
						res.json(result);
					}
				});
        },
        groupByuser : function getGroupByUser(req,res){
          var ipAddres = req.connection.remoteAddress;
  				var apikey = req.params.apikey;
          var user_id = req.params.user_id;

          checkApikey(apikey,ipAddres,function(result){
            if(result.err_code==0){
                var group_id = req.params.group_id;
                if(typeof group_id !== 'undefined'){
                  if(id.test(group_id)){
                    if(typeof group_id !== 'undefined'&&id.test(user_id)){
                      checkUser(user_id,function(result2){
                        if(result2.err_code==0){
                          Api_group.findWhereAnd([{"group_id": group_id},{"group_user_id":user_id}], function(err,data){
                              if(err){
                                 res.json(err);
                              }else{
                                //show data
                                if(data.length>0){
                                  //convert date
                                  showGroup(data,function(dataGroup){
                                    res.json({"err_code" : 0, "data" : dataGroup});
                                  });
                                }else{
                                  res.json({"err_code" : 2, "err_msg": "Group is not found"});
                                }
                              }
                          });
                        }else{
                          res.json(result2);
                        }
                      });
                    }else{
                      res.json({"err_code" : 2, "err_msg": "User ID must be numeric"});
                    }
                  }else{
                    res.json({"err_code" : 2, "err_msg": "Group ID must be numeric"});
                  }
                }else{
                  checkUser(user_id,function(result2){
                    if(result2.err_code==0){
                      Api_group.findWhere([{"group_user_id":user_id}], function(err,data){
                          if(err){
                             res.json(err);
                          }else{
                            //show data
                            if(data.length>0){
                              //convert date
                              showGroup(data,function(dataGroup){
                                res.json({"err_code" : 0, "data" : dataGroup});
                              });
                            }else{
                              res.json({"err_code" : 2, "err_msg": "Group is not found"});
                            }
                          }
                      });
                    }else{
                      res.json(result2);
                    }
                  });
                }
            }else {
              result.err_code = 500;
  						res.json(result);
            }
          });
        }
      },
			post: function addGroup(req, res){
				var ipAddres = req.connection.remoteAddress;
				var apikey = req.params.apikey;
				var group_name = req.body.group_name;      

				checkApikey(apikey, ipAddres, function(result){
					if(result.err_code == 0){
			      if(typeof req.body.group_name !== 'undefined'&& req.body.group_name!==""){
              //cek group name
  						checkGroupName(apikey, group_name, function(result2){
  							if(result2.err_code == 0){
                  var group_stat = {};
                  var idg_status;
  								if(typeof req.body.group_status !=='undefined'&&req.body.group_status!==""){
                    //ambil id group terakhir
                    if (req.body.group_status=='true')
                      idg_status = 1;
                    else
                      idg_status = 0;
                    group_stat.group_status = idg_status;
                    console.log("OK GANS ...");
                    console.log(group_stat.group_status);
                    getGroupId(apikey, function(result3){
    									if(result3.err_code == 0){
    										//susun body
                        //jadikan member group yang dibuat
                        getMemberId(apikey,function(result4){
                          var dataMember = {
                                            "member_id": result4.member_id,
                                            "user_id": result.data[0].user_id,
                                            "group_id": result3.group_id,
                                            "member_create_date": getFormattedDate(),
                                            "member_status" : "Active",
                                            "member_status_request" : "Confrim",
                                            "member_role" : "Administrator"
                                          };
                          Api_member.add(dataMember,function(err,data){});
                        });
    										var dataGroup = {
    																			"group_id": result3.group_id,
    																			"group_name": req.body.group_name,
    																			"group_status": group_stat.group_status,
    																			"group_is_active": true,
                                          "group_user_id" : result.data[0].user_id,
    																			"group_create_date": getFormattedDate()
    																		};

    										//proses simpan data group
    										Api_group.add(dataGroup,function(err,data){
    											if(err){
    										  	res.json({"err_code": 1, "err_msg": err, "application": "Api User Management", "function": "addGroup"});
    										  }else{
    										  	//cek apakah ada error atau tidak
    										  	if(data.errcode == 0){
    											  	Api_group.findById({"group_id": result3.group_id}, function(err,datapost){
                                  showGroup(datapost,function(dataGroup){
                                    res.json({"err_code" : 0, "data" : dataGroup});
                                  });
                               });
                            }else{
    										  		res.json(data);
    										  	}
    										  }
    										});
                      }else{
    										result.err_code = 500;
    										res.json(result3);
    									}
    								});
                  }else{
                    res.json({"err_code" : 2, "status" : "Group status is required"});
                  }
  							}else{
  								result.err_code = 500;
  								res.json(result2);
  							}
  						})
            }else{
              res.json({"err_code" : 2, "status" : "Group name is required"});
            }
					}else{
						result.err_code = 500;
						res.json(result);
					}
				});
			},
			put: function updateGroup(req, res){
        if(Object.keys(req.body).length){
				var ipAddres = req.connection.remoteAddress;
				var apikey = req.params.apikey;
        checkApikey(apikey, ipAddres, function(result){
					if(result.err_code == 0){
						//proses query ambil data user
						var group_id = req.params.group_id;
						if(typeof group_id !== 'undefined'&&id.test(group_id)){
              checkGroup(group_id,function(result2){
                if(result2.err_code==0&&(result.data[0].user_id==result2.data[0].group_user_id||result.status=="root")){
    							//cek untuk data yang akan diupdate
    							var dataGroup= {};
                  var params = true;                  
                  var idg_status;
    							if(typeof req.body.group_name !== 'undefined'&& req.body.group_name!==""){
    								dataGroup.group_name = req.body.group_name;
                  }else if(req.body.group_name =="")
                    params=false;

    							if(typeof req.body.group_is_active !== 'undefined'&&req.body.group_is_active!==""){
    								dataGroup.group_is_active = req.body.group_is_active;
    							}else if(req.body.group_is_active =="")
                    params= false;
   						
                  if(typeof req.body.group_status !== 'undefined' && req.body.group_status !== ""){
                    if (req.body.group_status=='true')
                      idg_status = 1;
                    else
                      idg_status = 0;
                    dataGroup.group_status = idg_status;
                  }else if(req.body.group_status =="")
                    params=false;

    							dataGroup.group_update_date = getFormattedDate();
                  if(params){
                    checkGroupName(apikey,dataGroup.group_name,function(result3){
                      if(result3.err_code==0){
                        Api_group.update({"group_id" : group_id},dataGroup,function(err,data){
                         if(err){
                           if(data.errcode==1)
                              res.json(data);
                            else
                              res.json(err);
                         }else{
                           Api_group.findById({"group_id": group_id}, function(err,dataUpdate){
                              showGroup(dataUpdate,function(dataGroup){
                                res.json({"err_code" : 0, "data" : dataGroup});
                                console.log(dataGroup);
                              });
                           });
                         }
                       });
                     }else{
                      console.log("Sini dlu bro");
                       res.json({"err_code": 2, "status": "Group is already exist"});
                     }
                    });
                  }else{
                    res.json({"err_code": 3, "status": "Parameters cannot Empty"});
                  }
    						}else if(result2.err_code==1){
                  res.json(result2);
                }else{
                  res.json({"err_code": 3, "err_msg": "Access denied. Cannot update Group"});
                }
              });
            }else{
							res.json({"err_code": 3, "err_msg": "Group ID must be numeric"});
						}
					}else{
						result.err_code = 500;
						res.json(result);
					}
				});
        }else{
          res.json({"err_code": 500, "err_msg": "Body cannot Empty"});
        }
			},
			delete: function deleteGroup(req, res){
				var ipAddres = req.connection.remoteAddress;
				var apikey = req.params.apikey;

				checkApikey(apikey, ipAddres, function(result){
					if(result.err_code == 0){
						//proses query ambil data user
						var group_id = req.params.group_id;
						if(typeof group_id !== 'undefined'&&id.test(group_id)){
              checkGroup(group_id,function(result2){
                if(result2.err_code==0&&(result.data[0].user_id==result2.data[0].group_user_id||result.status=="root")){
    							Api_group.delete([{"group_id" : group_id}], function(err,data){
                    if(err){
                      if(data.errcode==1)
                        res.json(data);
                      else
                        res.json(err);
                    }else{
                      var updateProject = {
                        "project_group_id" : null,
                        "project_is_share" : false,
                        "project_update_date" : getFormattedDate()
                      };//update project yang dimiliki, group menjadi not share dan menghilangkan kepemilikan project oleh group
                      Api_project.update({"project_group_id" : group_id},updateProject,function(err,data){});
                      Api_member.delete([{"group_id" : group_id}], function(err,data){
                        if(err){
                          if(data.errcode==1)
                            res.json({"err_code": 0, "status": "Group has been deleted"});
                          else
                            res.json(err);
                        }else{
                          res.json({"err_code": 0, "status": "Group has been deleted"});
                        }
                      });
                    }
                  });
                }else if (result2.err_code==1) {
                  res.json(result2);
                }else {
                  res.json({"err_code": 3, "err_msg": "Access denied. Cannot delete this Group"});
                }
              });
						}else{
							res.json({"err_code": 3, "err_msg": "Group ID must be numeric"});
						}
					}else{
						result.err_code = 500;
						res.json(result);
					}
				});
			}
}

var Member = {
			get: function getMember(req, res){
				var ipAddres = req.connection.remoteAddress;
				var apikey = req.params.apikey;

				checkApikey(apikey, ipAddres, function(result){
					if(result.err_code == 0){
						//proses query ambil data user
						var group_id = req.params.group_id;
						if(typeof group_id !== 'undefined'){
              if(id.test(group_id)){
                //check for the existing group
  							checkGroup(group_id,function(result2){
                   if(result2.err_code==0){
                      Api_group.findJoin({"group_id": group_id},{Member : "group_id"}, function(err,dataM){
                          if(err){
                            res.json(err);
                          }else{
                          	console.log(dataM);
                            console.log("SINI DLU GAN !!");                                                  
                            //show data
                            if(dataM[0].Members.length>0){
                              var member_group = [];
                              var count = 0;
                              for(key in dataM[0].Members){
                                member_group[key] = {
                                    "member_id" : dataM[0].Members[key].member_id,
                                    "group_name" : dataM[0].group_name
                                };

                                Api_user.findById({"user_id" : dataM[0].Members[key].user_id.toString()},function(err,dataU){
                                    if(err){
                                        res.json(err);
                                    }else{
                                    	console.log(dataU);
                                        if(dataU.length>0){
                                            if(dataU[0].user_lastname==null)
                                              dataU[0].user_lastname="null"
                                            member_group[count].user_id = dataU[0].user_id;
                                            member_group[count].user_firstname = dataU[0].user_firstname;
                                            member_group[count].user_lastname = dataU[0].user_lastname;
                                            member_group[count].user_email = dataU[0].user_email;

                                            if(dataM[0].Members[count].member_status==null)
                                              dataM[0].Members[count].member_status="null";
                                            if(dataM[0].Members[count].member_status_request==null)
                                              dataM[0].Members[count].member_status_request="null";
                                            member_group[count].member_status = dataM[0].Members[count].member_status;
                                            member_group[count].member_status_request = dataM[0].Members[count].member_status_request;
                                            member_group[count].member_role = dataM[0].Members[count].member_role;

                                            if(count==dataM[0].Members.length-1)
                                              res.json({"err_code" : 0, "data" : member_group});
                                            else
                                              count++;
                                        }else{
                                            res.json({"err_code" : 1, "err_msg" : "User is doesn't Exist"});
                                        }
                                    }
                                });
                                console.log('abac');
                                console.log(member_group);
                              }
                            }else{
                              res.json({"err_code": 2, "err_msg": "No member in this group"});
                            }
                          }
                      });
                  }else{
                    res.json({"err_code": 3, "err_msg": "Group ID is not found"});
                  }
                });
              }else{
                  res.json({"err_code": 3, "err_msg": "Group ID must be numeric"});
              }
            }else{
							res.json({"err_code": 3, "err_msg": "Group ID is not found"});
						}
					}else{
						result.err_code = 500;
						res.json(result);
					}
				});
			},
			post: function addMember(req, res){
				var ipAddres = req.connection.remoteAddress;
				var apikey = req.params.apikey;
				var group_id = req.body.group_id;
				var user_id = req.body.user_id;
				var member_create_by = req.body.create_by;

				checkApikey(apikey, ipAddres, function(result){
					if(result.err_code == 0){
             //cek group ada atau tidak
             if(id.test(group_id)){
               checkGroup(group_id,function(result2){
                 if(result2.err_code==0&&result.data[0].user_id==result2.data[0].group_user_id){
                    if(id.test(user_id)){
                    //cek user ada atau tidak
                      checkUser(user_id,function(result4){
                      	res.json(result4);
                        if(result4.err_code==0){
                          //cek apakah sudah menjadi member dari group tersebut
                          checkUserAsMember([{"user_id" : user_id},{"group_id" : group_id}], function(result5){
                            if(result5.err_code==1){
                              //ambil id member terakhir
                							getMemberId(apikey, function(result3){
                								if(result3.err_code == 0){
                									//susun body
                									var dataMember = {
                																		"member_id": result3.member_id,
                																		"user_id": user_id,
                																		"group_id": group_id,
                																		"member_create_date": getFormattedDate(),
                																		"member_status" : "Active",
                                                    "member_status_request" : "confirm",
                                                    "member_role" : "Member"
                																	};

                									//method, endpoint, params, options, callback
                									Api_member.add(dataMember,function(err,data){
                											if(err){
                										  	res.json({"err_code": 1, "err_msg": err, "application": "Api User Management", "function": "addMember"});
                										  }else{
                										  	//cek apakah ada error atau tidak
                										  	if(data.errcode == 0){
                                          var data_Member = {
                                            "member_id": result3.member_id,
                                            "group_id" : group_id,
                                            "user_id" : user_id
                                          };
                                          showMember(data_Member,function(result4){
                                            res.json({"err_code": 0, "data" : result4});
                                          });
                                        }else{
                										  		res.json(data);
                										  	}
                										  }
                										});
                                }else{
                									result3.err_code = 500;
                									res.json(result3);
                								}
                							});
                            }else{
       									      res.json({"err_code": 500, "status": "User is already member in this group"});
                            }
                          });
                        }else{
                            result4.err_code = 500;
                            res.json(result4);
                        }
                      });
                    }else {
                      res.json({"err_code": 3, "err_msg": "User ID must be numeric"});
                    }
                 }else if(result2.err_code==1){
                     res.json(result2);
                 }else {
                   res.json({"err_code": 3, "err_msg": "Access denied"});
                 }
               });
             }else {
               res.json({"err_code": 3, "err_msg": "Group ID must be numeric"});
             }
					}else{
						result.err_code = 500;
						res.json(result);
					}
				});
			},
			put: function updateMember(req, res){
				if(Object.keys(req.body).length){
        var ipAddres = req.connection.remoteAddress;
				var apikey = req.params.apikey;

				checkApikey(apikey, ipAddres, function(result){
					if(result.err_code == 0){
						//proses query ambil data user
						var member_id = req.params.member_id;
						var group_id = req.body.group_id;
						var user_id = req.body.user_id;
						var member_status = req.body.member_status;
            var member_role = req.body.member_role;
            var member_status_request = req.body.member_status_request;
            if(id.test(member_id)){
              checkMember(member_id,function(result2){
                if(result2.err_code==0){
      						if(typeof group_id !== 'undefined'&&id.test(group_id)){
                    checkGroup(group_id,function(result3){
                      if(result3.err_code==0&&result.data[0].user_id==result3.data[0].group_user_id){
          							if(typeof user_id !== 'undefined'&&id.test(user_id)){
                           checkUser(user_id,function(result4){
                             if(result4.err_code==0){
                               checkUserAsMember([{"user_id" : user_id},{"group_id" : group_id}], function(result5){
                                 if(result5.err_code==1){
                                    //cek untuk data yang akan diupdate
                    								var dataMember= {};

                    								dataMember.user_id = user_id;
                    								dataMember.group_id = group_id;
                                    var params = true;
                      							if(typeof req.body.member_status !== 'undefined'&& req.body.member_status!=="")
                                      dataMember.member_status = member_status;
                                    else if(req.body.member_status=="")
                                      params=false;
                                    if(typeof req.body.member_status_request !== 'undefined'&& req.body.member_status_request!=="")
                                      dataMember.member_status_request = member_status_request;
                                    else if(req.body.member_status_request=="")
                                      params=false;
                                    if(typeof req.body.member_role !== 'undefined'&& req.body.member_role!=="")
                                      dataMember.member_role = member_role;
                                    else if(req.body.member_role=="")
                                      params=false;


                                    if(params){
                                      dataMember.member_update_date = getFormattedDate();
                      								Api_member.update({"member_id" : member_id},dataMember,function(err,data){
                                         if(err){
                                           if(data.errcode==1)
                                              res.json(data);
                                            else
                                              res.json(err);
                                         }else{
                                           var data_Member = {
                                             "member_id": member_id,
                                             "group_id" : group_id,
                                             "user_id" : user_id
                                           };
                                           showMember(data_Member,function(result4){
                                             res.json({"err_code": 0, "data" : result4});
                                           });
                                        }
                                     });
                                    }else{
                                      res.json({"err_code": 3, "status": "Parameters cannot Empty"});
                                    }
                                 }else {
                                   res.json({"err_code": 2, "err_msg": "Member is already exist"});
                                 }
                               });
                             }else{
                               res.json(result4);
                             }
                           });
          							}else{
          								res.json({"err_code": 3, "err_msg": "User ID is required and must be numeric"});
          							}
      						    }else if(result3.err_code==1){
                        res.json(result3);
                      }else{
                        res.json({"err_code": 3, "err_msg": "Access denied"});
                      }
                    });
                  }else{
      							res.json({"err_code": 3, "err_msg": "Group ID is required and must be numeric"});
      						}
                }else{
                  res.json({"err_code": 3, "err_msg": "Member ID is not found"});
                }
              });
            }else {
              res.json({"err_code": 3, "err_msg": "Member ID must be numeric"});
            }
					}else{
						result.err_code = 500;
						res.json(result);
					}
				});
        }else{
          res.json({"err_code": 500, "err_msg": "Body cannot Empty"});
        }
			},
			delete: function deleteMember(req, res){
				var ipAddres = req.connection.remoteAddress;
				var apikey = req.params.apikey;
        var group_id = req.params.group_id
				checkApikey(apikey, ipAddres, function(result){
					if(result.err_code == 0){
            if(typeof group_id !== 'undefined'&&id.test(group_id)){
              checkGroup(group_id,function(result2){
                if(result2.err_code==0&&result.data[0].user_id==result2.data[0].group_user_id){
                  //proses query ambil data user
      						var member_id = req.params.member_id;
                  if(typeof member_id !== 'undefined'&&id.test(member_id)){
                    Api_member.findWhere({"group_id" : group_id},function(err,dataMember){
                      Api_member.delete([{"member_id" : member_id}], function(err,data){
                        if(err){
                          if(data.errcode==1)
                            res.json({"err_code": 1, "err_msg": "Member ID is not found"});
                          else
                            res.json(err);
                        }else{
                          if(dataMember.length>1){
                            //check member as admin's group
                            if(dataMember[0].user_id==result2.data[0].group_user_id){
                              //change admin's group
                              console.log("change admin")
                              var updateGroup = {"group_user_id" : dataMember[1].user_id, "group_update_date" : getFormattedDate()};
                              Api_group.update({"group_id" : group_id},updateGroup,function(err,data){});
                              var updateMember = {"member_role" : "Administrator", "member_update_date" : getFormattedDate()};
                              Api_member.update({"member_id" : dataMember[1].member_id},updateMember,function(err,data){});
                              res.json({"err_code": 0, "status": "Member has been deleted"})
                            }else{
                              console.log("admin not change")
                              res.json({"err_code": 0, "status": "Member has been deleted"})
                            }
                          }else{
                            //member hanya satu sebelum member di hapus
                            var updateProject = {
                              "project_group_id" : null,
                              "project_is_share" : false,
                              "project_update_date" : getFormattedDate()
                            };//update project yang dimiliki, group menjadi not share dan menghilangkan kepemilikan project oleh group
                            Api_project.update({"project_group_id" : group_id},updateProject,function(err,data){});
                            //delete group karena sudah tidak ada member
                            Api_group.delete([{"group_id" : group_id}],function(err,data){
                              res.json({"err_code": 0, "status": "Member and Group has been deleted"});
                            });
                          }
                        }
                      });
                    });
        					}else {
                    res.json({"err_code": 3, "err_msg": "Member ID must be numeric"});
                  }
                }else if(result2.err_code==1){
                  res.json(result2)
                }else {
                  res.json({"err_code": 3, "err_msg": "Access denied. Cannot delete this Member"});
                }
              });
            }else{
              res.json({"err_code": 3, "err_msg": "Group ID must be numeric"});
            }
					}else{
						result.err_code = 500;
						res.json(result);
					}
				});
			}
}

var Role = {
			get: function getRole(req, res){
				var ipAddres = req.connection.remoteAddress;
				var apikey = req.params.apikey;

				checkApikey(apikey, ipAddres, function(result){
					if(result.err_code == 0){
						//proses query ambil data user
						var role_id = req.params.role_id;
						if(typeof role_id !== 'undefined'){
              if(id.test(role_id)){
                //Api_role.findJoin({"role_id": role_id},{Privilege :"privilege_role_id"}, function(err,data)
                Api_role.findById({"role_id": role_id}, function(err,data){
                    if(err){
                       res.json(err);
                    }else{
                      //show data
                      if(data.length>0){
                        data[0].role_create_date = data[0].role_create_date.slice(0,19).replace('T',' ');
                        if(data[0].role_update_date!==null)
                          data[0].role_update_date = data[0].role_update_date.slice(0,19).replace('T',' ');
                        else
                          data[0].role_update_date="null"
                        res.json({"err_code" :0, "data" : data});
                        /*showRole(data,function(dataRole){
                          res.json(dataRole);
                        });*/
                      }else{
                        res.json({"err_code" : 2, "err_msg": "Role id is not found"});
                      }
                    }
                });
              }else {
                res.json({"err_code": 3, "err_msg": "Role ID must be numeric"});
              }
						}else{
							Api_role.findById({}, function(err,data){
                if(err){
                  if(data.errcode==1)
                    res.json(data);
                  else
                    res.json(err);
                }else{
               	  //cek jumdata dulu
								  if(data.length > 0){
                    //take necessary data
                    for(key in data){
                      data[key].role_create_date = data[key].role_create_date.slice(0,19).replace('T',' ');
                      if(data[key].role_update_date!==null)
                        data[key].role_update_date = data[key].role_update_date.slice(0,19).replace('T',' ');
                      else
                        data[key].role_update_date="null"
                    }res.json({"err_code" :0, "data" : data});
                    /*showRole(data,function(dataRole){
                      res.json(dataRole);
                    });*/
                  }else{
							  		res.json({"err_code": 4, "err_msg": "Role data is empty", "application": "Api User Management", "function": "getRole"});
								  }
                }
              });
            }
					}else{
						result.err_code = 500;
						res.json(result);
					}
				});
			},
			post: function addRole(req, res){
				var ipAddres = req.connection.remoteAddress;
				var apikey = req.params.apikey;
				var role_name = req.body.role_name;

				checkApikey(apikey, ipAddres, function(result){
					if(result.err_code == 0){
             if(typeof req.body.role_name !== 'undefined'&& req.body.role_name!==""){
    						//cek role name sudah ada atau tidak
    						checkRoleName(apikey, role_name, function(result2){
    							if(result2.err_code == 0){
    								//ambil id user terakhir
    								getRoleId(apikey, function(result3){
    									if(result3.err_code == 0){
    										//susun body
    										var dataRole = {
    																			"role_id": result3.role_id,
    																			"role_name": role_name,
    																			"role_create_date": getFormattedDate()
    																		};

    										//proses simpan data user
    										Api_role.add(dataRole,function(err,data){
    											if(err){
    										  	res.json({"err_code": 1, "err_msg": err, "application": "Api User Management", "function": "addRole"});
    										  }else{
    										  	//cek apakah ada error atau tidak
    										  	if(data.errcode == 0){
          									  	Api_role.findById({"role_id": result3.role_id}, function(err,datapost){
                                  datapost[0].role_create_date = datapost[0].role_create_date.slice(0,19).replace('T',' ');
                                  if(datapost[0].role_update_date!==null)
                                    datapost[0].role_update_date = datapost[0].role_update_date.slice(0,19).replace('T',' ');
                                  else
                                    datapost[0].role_update_date = "null";
                                  res.json({"err_code": 0, "data" : datapost});
                               });
                            }else{
    										  		res.json(data);
    										  	}
    										  }
    										});
                      }else{
    										result.err_code = 500;
    										res.json(result3);
    									}
    								});
    							}else{
    								result.err_code = 500;
    								res.json(result2);
    							}
    						})
            }else{
              res.json({"err_code" : 2, "status" : "Role name is required"});
            }
					}else{
						result.err_code = 500;
						res.json(result);
					}
				});
			},
			put: function updateRole(req, res){
        if(Object.keys(req.body).length){
				var ipAddres = req.connection.remoteAddress;
				var apikey = req.params.apikey;

				checkApikey(apikey, ipAddres, function(result){
					if(result.err_code == 0){
						//proses query ambil data user
						var role_id = req.params.role_id;
						if(typeof role_id !== 'undefined'&&id.test(role_id)){
							//cek untuk data yang akan diupdate
							var dataRole= {};
							if(typeof req.body.role_name !== 'undefined' && req.body.role_name!==""){
								dataRole.role_name = req.body.role_name;

                dataRole.role_update_date = getFormattedDate();
                Api_role.update({"role_id" : role_id},dataRole,function(err,data){
                   if(err){
                     if(data.errcode==1)
                        res.json({"err_code" : 2, "err_msg": "Role id is not found"});
                      else
                        res.json(err);
                   }else{
                     Api_role.findById({"role_id": role_id}, function(err,dataUpdate){
                        dataUpdate[0].role_create_date = dataUpdate[0].role_create_date.slice(0,19).replace('T',' ');
                        if(dataUpdate[0].role_update_date!==null)
